# CI Workflow - Automated Testing
# 
# This workflow runs automatically on:
# - Every push to 'develop' branch
# - Every Pull Request to 'main' or 'develop'
#
# What it does:
# - Tests the code on PHP 8.2 and 8.3
# - Runs integration tests with Redis 7.2
# - Generates code coverage report
# - Uploads coverage to Codecov (PHP 8.3 only)

name: CI

on:
  # Trigger on push to develop (not main - it's protected)
  push:
    branches: [ develop ]
  
  # Trigger on all Pull Requests
  pull_request:
    branches: [ main, develop ]
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  tests:
    # Job name - appears in GitHub Actions UI
    # ${{ matrix.php }} gets replaced with actual PHP version (8.2 or 8.3)
    name: Tests (PHP ${{ matrix.php }})
    
    # Use Ubuntu (free on GitHub Actions)
    runs-on: ubuntu-latest
    
    # Test matrix - creates one job per PHP version
    strategy:
      # Don't stop other jobs if one fails
      fail-fast: false
      
      matrix:
        # Test on these PHP versions
        php: ['8.2', '8.3']
    
    # Redis service - runs in a Docker container
    services:
      redis:
        # Use Redis 7.2 Alpine (lightweight)
        image: redis:7.2-alpine
        
        # Expose Redis port to the host
        ports:
          - 6379:6379
        
        # Health check - wait until Redis is ready
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    # Job steps - executed sequentially
    steps:
      # Step 1: Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Setup PHP with required extensions
      - name: Setup PHP ${{ matrix.php }}
        uses: shivammathur/setup-php@v2
        with:
          # PHP version from matrix
          php-version: ${{ matrix.php }}
          
          # Required PHP extensions
          extensions: redis, json, mbstring
          
          # Enable Xdebug for code coverage
          coverage: xdebug
          
          # Install Composer v2
          tools: composer:v2
      
      # Step 3: Cache Composer dependencies (speeds up builds)
      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          # Cache path
          path: ~/.composer/cache
          
          # Cache key based on composer.lock hash
          # If composer.lock changes, cache is invalidated
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          
          # Fallback keys if exact match not found
          restore-keys: ${{ runner.os }}-composer-
      
      # Step 4: Install project dependencies
      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction
      
      # Step 5: Validate composer.json structure
      - name: Validate composer.json
        run: composer validate --strict
      
      # Step 6: Display versions (helpful for debugging)
      - name: Display versions
        run: |
          php -v
          php -m | grep redis
          composer --version
      
      # Step 7: Run integration tests
      # SKIP_INTEGRATION_TESTS=false enables integration tests
      - name: Run integration tests
        run: composer test:integration
        env:
          REDIS_HOST: 127.0.0.1
          REDIS_PORT: 6379
      
      # Step 8: Upload coverage (only for PHP 8.3 to avoid duplicates)
      - name: Upload coverage to Codecov
        if: matrix.php == '8.3'
        uses: codecov/codecov-action@v3
        with:
          # Coverage file generated by PHPUnit
          files: ./coverage.xml
          
          # Don't fail the build if upload fails
          fail_ci_if_error: false
          
          # Flags to identify this upload on Codecov
          flags: php-${{ matrix.php }}
