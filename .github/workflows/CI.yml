# CI Workflow - Automated Testing
# 
# Triggers:
# - Push to develop branch
# - Pull Requests to main or develop
# - Manual trigger via GitHub UI
#
# What it does:
# - Tests code on PHP 8.4.x and 8.5.x (latest patch versions)
# - Runs integration tests with Redis 7.2
# - Generates code coverage report
# - Uploads coverage to Codecov

name: CI

on:
  # Trigger on push to develop
  push:
    branches: [ develop ]
  
  # Trigger on all Pull Requests
  pull_request:
    branches: [ main, develop ]
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  tests:
    # Job name displayed in GitHub Actions interface
    name: Tests (PHP ${{ matrix.php }})
    
    # Use Ubuntu runner (free tier on GitHub Actions)
    runs-on: ubuntu-latest
    
    # Test matrix - creates one job per PHP version
    strategy:
      # Continue running other jobs even if one fails
      fail-fast: false
      
      matrix:
        # Test on latest stable PHP versions
        # Automatically uses latest patch: 8.4.x and 8.5.x
        php: ['8.4', '8.5']
    
    # Redis service - runs in Docker container
    services:
      redis:
        # Use Redis 7.2 Alpine (lightweight image)
        image: redis:7.2-alpine
        
        # Expose Redis port to the host machine
        ports:
          - 6379:6379
        
        # Health check - wait until Redis is ready before running tests
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    # Sequential steps executed for this job
    steps:
      # Step 1: Checkout repository code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Setup PHP with required extensions
      - name: Setup PHP ${{ matrix.php }}
        uses: shivammathur/setup-php@v2
        with:
          # PHP version from matrix (automatically uses latest patch)
          php-version: ${{ matrix.php }}
          
          # Required PHP extensions for the project
          extensions: redis, json, mbstring
          
          # Enable Xdebug for code coverage generation
          coverage: xdebug
          
          # Install Composer v2
          tools: composer:v2
      
      # Step 3: Cache Composer dependencies (speeds up subsequent builds)
      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          # Composer cache directory location
          path: ~/.composer/cache
          
          # Cache key based on OS and composer.lock hash
          # Cache invalidates when composer.lock changes
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          
          # Fallback cache keys if exact match not found
          restore-keys: ${{ runner.os }}-composer-
      
      # Step 4: Install project dependencies via Composer
      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction
      
      # Step 5: Validate composer.json and composer.lock structure
      - name: Validate composer files
        run: composer validate --strict
      
      # Step 6: Display installed versions (helpful for debugging CI failures)
      - name: Display versions
        run: |
          php -v
          php -m | grep redis
          composer --version
      
      # Step 7: Run integration tests with Redis
      # Environment variables configure Redis connection for tests
      - name: Run integration tests
        run: composer test:integration
        env:
          REDIS_HOST: 127.0.0.1
          REDIS_PORT: 6379
      
      # Step 8: Upload code coverage report to Codecov
      # Only runs for PHP 8.5 to avoid duplicate coverage reports
      - name: Upload coverage to Codecov
        if: matrix.php == '8.5'
        uses: codecov/codecov-action@v3
        with:
          # Coverage file generated by PHPUnit (--coverage-clover flag)
          files: ./coverage.xml
          
          # Don't fail the build if coverage upload fails
          fail_ci_if_error: false
          
          # Tags for organizing coverage reports on Codecov dashboard
          flags: php-${{ matrix.php }}
